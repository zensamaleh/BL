# 🔧 Configuration Supabase pour l'Application BL Management\n\n## 📋 Étapes de Configuration\n\n### 1. Accès au Dashboard Supabase\n1. Connectez-vous à [Supabase Dashboard](https://supabase.com/dashboard)\n2. Naviguez vers votre projet : `siicppcypillvxkoycep`\n\n### 2. Création des Tables\n1. Dans le dashboard, allez dans **SQL Editor**\n2. Cliquez sur **+ New query**\n3. Copiez et collez le contenu du fichier `SUPABASE_SETUP.sql`\n4. Cliquez sur **Run** pour exécuter le script\n\n### 3. Vérification\nAprès exécution, vous devriez voir :\n- ✅ Message de confirmation\n- ✅ Liste des 8 tables créées :\n  - `users`\n  - `bons_livraison`\n  - `bl_images`\n  - `ecarts`\n  - `palettes_stockees`\n  - `activity_logs`\n  - `rapports`\n\n### 4. Configuration des Politiques de Sécurité (RLS)\n\nPour sécuriser l'accès aux données, configurez les Row Level Security (RLS) :\n\n```sql\n-- Activer RLS sur toutes les tables\nALTER TABLE users ENABLE ROW LEVEL SECURITY;\nALTER TABLE bons_livraison ENABLE ROW LEVEL SECURITY;\nALTER TABLE bl_images ENABLE ROW LEVEL SECURITY;\nALTER TABLE ecarts ENABLE ROW LEVEL SECURITY;\nALTER TABLE palettes_stockees ENABLE ROW LEVEL SECURITY;\nALTER TABLE activity_logs ENABLE ROW LEVEL SECURITY;\nALTER TABLE rapports ENABLE ROW LEVEL SECURITY;\n\n-- Politique pour les utilisateurs (lecture seule de son propre profil)\nCREATE POLICY \"Users can read own profile\" ON users\n  FOR SELECT USING (auth.uid()::text = id::text);\n\n-- Politique pour les bons de livraison (selon le rôle)\nCREATE POLICY \"Chauffeurs can read own BL\" ON bons_livraison\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM users \n      WHERE users.id::text = auth.uid()::text \n      AND users.role = 'chauffeur'\n      AND users.id = bons_livraison.chauffeur_id\n    )\n  );\n\nCREATE POLICY \"Agents and Chefs can read all BL\" ON bons_livraison\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM users \n      WHERE users.id::text = auth.uid()::text \n      AND users.role IN ('agent', 'chef')\n    )\n  );\n\n-- Plus de politiques selon les besoins...\n```\n\n## 🔑 Credentials à Utiliser\n\n### Variables d'Environnement (.env)\n```bash\n# Database URL (pour connexion PostgreSQL directe si disponible)\nDATABASE_URL=postgresql://postgres:46tm79uMd3vmBPTQ@db.siicppcypillvxkoycep.supabase.co:5432/postgres\n\n# Supabase REST API\nVITE_PUBLIC_SUPABASE_URL=https://siicppcypillvxkoycep.supabase.co\nVITE_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpaWNwcGN5cGlsbHZ4a295Y2VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzExODgsImV4cCI6MjA3MDI0NzE4OH0.FDcZRhVVr6wtZW7noEljbYnHUWG-LsnSSyNC_VYnJI4\nSUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpaWNwcGN5cGlsbHZ4a295Y2VwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDY3MTE4OCwiZXhwIjoyMDcwMjQ3MTg4fQ.o4Wpa7FuolIgIk_88pHHvWhuMfMdRC7TddwS7RPZSd8\n```\n\n## 🧪 Test de Connexion\n\nAprès configuration, testez la connexion :\n\n```bash\n# Dans le répertoire backend\ncd backend\nnpm run build\n\n# Test de l'API REST (fonctionne déjà)\nnode -e \"\nconst fetch = require('node-fetch');\nfetch('https://siicppcypillvxkoycep.supabase.co/rest/v1/users?select=username,role', {\n  headers: {\n    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpaWNwcGN5cGlsbHZ4a295Y2VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzExODgsImV4cCI6MjA3MDI0NzE4OH0.FDcZRhVVr6wtZW7noEljbYnHUWG-LsnSSyNC_VYnJI4',\n    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpaWNwcGN5cGlsbHZ4a295Y2VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzExODgsImV4cCI6MjA3MDI0NzE4OH0.FDcZRhVVr6wtZW7noEljbYnHUWG-LsnSSyNC_VYnJI4'\n  }\n})\n.then(r => r.json())\n.then(d => console.log('✅ Utilisateurs:', d))\n.catch(e => console.log('❌ Erreur:', e.message));\n\"\n```\n\n## 🚀 Comptes de Test\n\nAprès exécution du script SQL, vous aurez ces comptes de test :\n\n| Username | Role | Email | Mot de passe |\n|----------|------|-------|-------------|\n| admin | chef | admin@aegean.com | admin123 |\n| chauffeur1 | chauffeur | chauffeur1@aegean.com | user123 |\n| chauffeur2 | chauffeur | chauffeur2@aegean.com | user123 |\n| agent1 | agent | agent1@aegean.com | user123 |\n| agent2 | agent | agent2@aegean.com | user123 |\n| chef1 | chef | chef1@aegean.com | admin123 |\n\n## 🔄 État Actuel\n\n### ✅ Fonctionnel\n- Connectivité HTTPS vers Supabase\n- API REST Supabase accessible\n- Structure de base de données définie\n- Backend API développé\n- Frontend React complet\n\n### ⏳ À Faire\n1. **Exécuter le script SQL** dans Supabase Dashboard\n2. **Configurer RLS** (politiques de sécurité)\n3. **Tester l'API complète** avec vraies données\n4. **Connecter frontend-backend**\n\n## 🆘 Résolution de Problèmes\n\n### Problème : Tables non créées\n**Solution :** Exécutez le script `SUPABASE_SETUP.sql` dans SQL Editor\n\n### Problème : Accès refusé aux tables\n**Solution :** Configurez les politiques RLS ou désactivez temporairement :\n```sql\nALTER TABLE nom_table DISABLE ROW LEVEL SECURITY;\n```\n\n### Problème : Connexion PostgreSQL directe\n**Solution :** Utilisez l'API REST en attendant. Le problème de DNS IPv6 sera résolu en production.\n\n---\n\n**Statut :** 🟡 **Prêt pour configuration manuelle**  \n**Prochaine étape :** Exécuter le script SQL dans Supabase Dashboard", "old_string": null}]